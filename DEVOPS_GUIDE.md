# DevOps Guide - Life Management Application

## Quick Reference

### First Time Setup
```bash
make setup
# or
./scripts/setup.sh
```

### Daily Development
```bash
make up          # Start services
make logs        # Watch logs
make down        # Stop services
```

## Infrastructure Components

### 1. Docker Compose Services

**Development Stack** (`docker-compose.yml`)
- PostgreSQL 15 (port 5432)
- Redis 7 (port 6379)
- Node.js Backend (port 3000)
- React Frontend (port 3001)

**Production Stack** (`docker-compose.prod.yml`)
- All development services
- Nginx reverse proxy (ports 80, 443)
- Production-optimized builds
- Health checks enabled

### 2. GitHub Actions Workflows

**CI Pipeline** (`.github/workflows/ci.yml`)
- Triggered on: Pull requests, pushes to develop
- Backend tests with PostgreSQL/Redis
- Frontend tests and build
- Docker image build verification
- Security scanning (Trivy)
- Integration tests

**CD Pipeline** (`.github/workflows/deploy.yml`)
- Triggered on: Push to main, manual workflow dispatch
- Builds and pushes Docker images to GHCR
- Deploys to staging automatically
- Deploys to production with manual approval
- Includes rollback on failure

### 3. Development Scripts

| Script | Purpose | Usage |
|--------|---------|-------|
| `setup.sh` | Complete environment setup | `./scripts/setup.sh` |
| `backup.sh` | Database backup | `./scripts/backup.sh` |
| `restore.sh` | Database restore | `./scripts/restore.sh [file]` |
| `seed.sh` | Populate sample data | `./scripts/seed.sh` |

## Configuration Management

### Environment Variables Hierarchy

1. **Local Development** (`.env`)
   - Copy from `.env.example`
   - Auto-generated by `setup.sh`
   - Not committed to git

2. **GitHub Secrets** (CI/CD)
   - `STAGING_ENV` - Complete staging environment
   - `PRODUCTION_ENV` - Complete production environment
   - SSH keys for deployment

3. **Docker Compose** (defaults)
   - Fallback values in `docker-compose.yml`
   - Use format: `${VAR:-default}`

### Critical Security Settings

⚠️ **Always change in production:**

```bash
DB_PASSWORD=          # Strong password (16+ chars)
REDIS_PASSWORD=       # Strong password (16+ chars)
JWT_SECRET=          # Random string (32+ chars)
```

## Deployment Strategies

### Local Development Deployment

```bash
# Clean deployment
make clean
make setup

# Quick restart
make restart

# Rebuild specific service
docker-compose up -d --build backend
```

### Staging Deployment

**Automated via GitHub Actions:**
1. Push to `main` branch
2. CI tests pass
3. Docker images built and pushed to GHCR
4. SSH deployment to staging server
5. Health checks verify deployment

**Manual staging deployment:**
```bash
# On staging server
cd /opt/life-management
git pull origin main
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d --no-deps
```

### Production Deployment

**Via GitHub Actions (Recommended):**
1. Go to Actions tab
2. Select "CD - Continuous Deployment"
3. Click "Run workflow"
4. Select "production" environment
5. Approve deployment
6. Monitor health checks

**Manual production deployment:**
```bash
# Create backup first!
./scripts/backup.sh

# Deploy
cd /opt/life-management
git pull origin main
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d --no-deps --build

# Verify
curl -f https://yourdomain.com/health
```

### Zero-Downtime Deployment

Docker Compose performs rolling updates:
```bash
docker-compose up -d --no-deps --build backend
```

This:
1. Builds new container
2. Starts new container
3. Waits for health check
4. Stops old container

## Monitoring & Observability

### Health Checks

All services include health checks:

```bash
# Check via Make
make health

# Manual checks
curl http://localhost:3000/health  # Backend
curl http://localhost:3001/        # Frontend
docker-compose exec postgres pg_isready -U lifeapp
docker-compose exec redis redis-cli ping
```

### Log Management

```bash
# Real-time logs (all services)
make logs

# Specific service
make logs-backend
make logs-frontend
make logs-db

# Search logs
docker-compose logs backend | grep ERROR

# Export logs
docker-compose logs > logs-$(date +%Y%m%d).txt
```

### Resource Monitoring

```bash
# Container resource usage
make stats

# Disk usage
docker system df

# Network inspection
docker network inspect home_life-mgmt-network
```

## Database Management

### Backup Strategy

**Automated backups** (recommended):
```bash
# Add to crontab
0 2 * * * cd /opt/life-management && ./scripts/backup.sh
```

**Manual backup:**
```bash
make backup
# or
./scripts/backup.sh
```

Backups are:
- Timestamped automatically
- Compressed (gzip)
- Stored in `./backups/`
- Limited to last 10 (auto-cleanup)

### Restore Procedures

**Restore latest backup:**
```bash
./scripts/restore.sh latest
```

**Restore specific backup:**
```bash
./scripts/restore.sh backup_20240101_120000.sql.gz
```

The restore script:
- Creates a safety backup before restoring
- Prompts for confirmation
- Verifies restoration

### Database Migrations

```bash
# Run migrations
make migrate

# Or directly
docker-compose exec backend npm run migrate
```

## Troubleshooting Guide

### Common Issues

**1. Port Already in Use**
```bash
# Find process using port
lsof -i :3000

# Kill process
kill -9 <PID>

# Or change port in .env
BACKEND_PORT=3001
```

**2. Database Connection Failed**
```bash
# Check database is running
docker-compose ps postgres

# Check database health
docker-compose exec postgres pg_isready

# View database logs
make logs-db

# Restart database
docker-compose restart postgres
```

**3. Frontend Can't Reach Backend**
```bash
# Verify CORS settings in .env
CORS_ORIGIN=http://localhost:3001

# Verify API URL in frontend
REACT_APP_API_URL=http://localhost:3000

# Restart services
make restart
```

**4. Out of Disk Space**
```bash
# Check disk usage
docker system df

# Clean up
make prune

# Remove all stopped containers and images
docker system prune -af --volumes
```

**5. Services Not Starting**
```bash
# View all logs
make logs

# Clean slate restart
make clean
make up
```

### Performance Issues

**Backend slow responses:**
```bash
# Check container resources
make stats

# Increase container memory (docker-compose.yml)
deploy:
  resources:
    limits:
      memory: 1G
```

**Database slow queries:**
```bash
# Connect to database
make shell-db

# Check slow queries
SELECT * FROM pg_stat_activity
WHERE state = 'active'
AND query_start < now() - interval '5 seconds';
```

## CI/CD Troubleshooting

### GitHub Actions Failures

**Tests failing:**
1. Check test logs in Actions tab
2. Run tests locally: `make test`
3. Verify test database connection

**Build failing:**
1. Check Dockerfile syntax
2. Build locally: `make build`
3. Review build logs

**Deployment failing:**
1. Verify SSH access to server
2. Check GitHub secrets are set
3. Review deployment logs
4. Verify server disk space

### Required GitHub Secrets

Setup in Settings → Secrets and variables → Actions:

**Server Access:**
- `STAGING_HOST` - e.g., `staging.example.com`
- `STAGING_USER` - SSH username
- `STAGING_SSH_KEY` - Private SSH key
- `PRODUCTION_HOST` - Production server
- `PRODUCTION_USER` - SSH username
- `PRODUCTION_SSH_KEY` - Private SSH key

**Application Config:**
- `STAGING_ENV` - Complete `.env` file content
- `PRODUCTION_ENV` - Complete `.env` file content
- `REACT_APP_API_URL` - Frontend API endpoint

## Security Checklist

### Before Production Deployment

- [ ] Changed default passwords in `.env`
- [ ] Generated strong JWT secret (32+ characters)
- [ ] Configured CORS to specific domain
- [ ] SSL/TLS certificates installed
- [ ] Environment secrets set in GitHub
- [ ] Disabled debug mode (`NODE_ENV=production`)
- [ ] Configured rate limiting
- [ ] Set up automated backups
- [ ] Reviewed nginx security headers
- [ ] Ran security scan (`npm audit`)
- [ ] Updated all dependencies
- [ ] Set up monitoring/alerting
- [ ] Documented incident response plan

## Performance Optimization

### Backend Optimization
```javascript
// Connection pooling (in backend code)
const pool = new Pool({
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});
```

### Database Optimization
```sql
-- Analyze query performance
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';

-- Create indexes for common queries
CREATE INDEX idx_tasks_user_status ON tasks(user_id, status);
```

### Caching Strategy
```javascript
// Redis caching example
const cacheKey = `user:${userId}`;
let user = await redis.get(cacheKey);

if (!user) {
  user = await db.query('SELECT * FROM users WHERE id = $1', [userId]);
  await redis.setex(cacheKey, 3600, JSON.stringify(user));
}
```

## Scaling Guide

### Horizontal Scaling

**Scale backend:**
```bash
docker-compose up -d --scale backend=3
```

**Load balancing** (nginx auto-configured):
```nginx
upstream backend {
    server backend:3000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}
```

### Database Scaling

**Read replicas:**
1. Set up PostgreSQL streaming replication
2. Configure read-only connections
3. Update connection pool

**Connection pooling:**
```bash
# Install PgBouncer
docker run -d --name pgbouncer \
  -e DATABASES_HOST=postgres \
  -p 6432:6432 \
  edoburu/pgbouncer
```

## Maintenance Tasks

### Weekly
- [ ] Review error logs
- [ ] Check disk space
- [ ] Verify backups
- [ ] Review security alerts

### Monthly
- [ ] Update dependencies
- [ ] Review performance metrics
- [ ] Database maintenance (VACUUM)
- [ ] Rotate logs

### Quarterly
- [ ] Security audit
- [ ] Disaster recovery drill
- [ ] Review and update documentation
- [ ] Performance testing

## Support & Resources

- **Documentation**: This file and README.md
- **Logs**: `make logs`
- **Health Checks**: `make health`
- **Community**: [Your community link]
- **Issues**: GitHub Issues

## Useful Commands Reference

```bash
# Setup
make setup              # Initial setup
make env               # Create .env file

# Development
make up                # Start services
make down              # Stop services
make restart           # Restart all
make rebuild           # Rebuild and restart
make logs              # View all logs
make health            # Check health

# Database
make backup            # Backup database
make restore           # Restore database
make seed              # Seed sample data
make migrate           # Run migrations
make shell-db          # PostgreSQL CLI

# Containers
make shell-backend     # Backend shell
make shell-frontend    # Frontend shell
make ps                # Service status
make stats             # Resource usage

# Testing
make test              # Run tests
make lint              # Run linters

# Cleanup
make clean             # Remove containers and volumes
make prune             # Remove unused Docker resources

# Production
make prod-up           # Start production
make prod-down         # Stop production
make prod-logs         # Production logs
```

---

**Last Updated**: 2024
**Maintained by**: DevOps Team
